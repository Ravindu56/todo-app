<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Notes - Todo App</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* unify with tasks: strike-through + pre-wrap for content */
        .text-strikethrough { text-decoration: line-through; color: grey; }
        .note-card { margin-bottom: 1rem; }
        .pre-wrap { white-space: pre-wrap; }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>Notes</h2>
            <div>
                <a href="/" class="btn btn-outline-secondary me-2">Home</a>
                <a href="/tasks" class="btn btn-outline-primary">Tasks</a>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card mb-3">
                    <div class="card-body">
                        <h5 class="card-title">Add a Note</h5>
                        <form action="/notes" method="post">
                            <div class="mb-3">
                                <input type="text" class="form-control" name="title" placeholder="Note title" required>
                            </div>
                            <div class="mb-3">
                                <textarea class="form-control" name="content" rows="5" placeholder="Write your note here" required></textarea>
                            </div>
                            <div class="d-flex">
                                <a href="/" class="btn btn-outline-secondary me-2">Home</a>
                                <button class="btn btn-primary ms-auto" type="submit">Add Note</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-md-8">
                <div class="row row-cols-1 row-cols-md-2 g-3">
                    <th:block th:each="note: ${notes}">
                        <div class="col">
                            <div class="card h-100 note-card" role="button"
                                 th:attr="data-id=${note.id}, data-title=${note.title}, data-content=${note.content}, data-createdat=${note.createdAt}">
                                <div class="card-body">
                                    <h5 class="card-title" th:text="${note.title}">Note Title</h5>
                                    <p class="card-text text-break pre-wrap" th:text="${note.content}">Note content</p>
                                </div>
                                <div class="card-footer text-muted small d-flex align-items-center">
                                    <span class="me-auto" th:if="${note.createdAt != null}" th:text="${#temporals.format(note.createdAt, 'yyyy-MM-dd HH:mm')}"></span>
                                    <div>
                                        <button type="button" class="btn btn-sm btn-outline-warning me-2 edit-note-btn" title="Edit" onclick="event.stopPropagation();">Edit</button>
                                        <a th:href="@{'/notes/' + ${note.id} + '/delete'}" class="btn btn-sm btn-danger">Delete</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </th:block>
                </div>
            </div>
        </div>

        <!-- Note Preview Modal -->
        <div class="modal fade" id="notePreviewModal" tabindex="-1" aria-labelledby="notePreviewModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="notePreviewModalLabel">Note Preview</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <h4 id="previewTitle"></h4>
                        <p class="text-muted small" id="previewDate"></p>
                        <hr>
                        <p id="previewContent" class="pre-wrap text-break"></p>
                    </div>
                    <div class="modal-footer">
                        <a href="/notes" class="btn btn-outline-secondary">Notes</a>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit Note Modal -->
        <div class="modal fade" id="editNoteModal" tabindex="-1" aria-labelledby="editNoteModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editNoteModalLabel">Edit Note</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <form id="editNoteForm" method="post" action="/notes/0/edit">
                        <div class="modal-body">
                            <div class="mb-3">
                                <label class="form-label">Title</label>
                                <input id="editNoteTitle" type="text" class="form-control" name="title" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Content</label>
                                <textarea id="editNoteContent" class="form-control" name="content" rows="6" required></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="submit" class="btn btn-primary">Save changes</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

</body>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Open preview modal when clicking a note card
        document.addEventListener('DOMContentLoaded', function(){
            document.querySelectorAll('.note-card').forEach(function(card){
                card.addEventListener('click', function(){
                    const title = card.getAttribute('data-title') || '';
                    const content = card.getAttribute('data-content') || '';
                    const createdAt = card.getAttribute('data-createdat') || '';

                    document.getElementById('previewTitle').textContent = title;
                    document.getElementById('previewContent').textContent = content;
                    document.getElementById('previewDate').textContent = createdAt ? createdAt.replace('T',' ') : '';

                    const modalEl = document.getElementById('notePreviewModal');
                    const modal = new bootstrap.Modal(modalEl);
                    modal.show();
                });
            });

            // Edit button: open edit modal populated with note data
            document.querySelectorAll('.edit-note-btn').forEach(function(btn){
                btn.addEventListener('click', function(event){
                    // stop the parent card click
                    event.stopPropagation();

                    // find parent card element
                    let card = btn.closest('.note-card');
                    if(!card) return;

                    const id = card.getAttribute('data-id');
                    const title = card.getAttribute('data-title') || '';
                    const content = card.getAttribute('data-content') || '';

                    const form = document.getElementById('editNoteForm');
                    form.action = '/notes/' + id + '/edit';

                    document.getElementById('editNoteTitle').value = title;
                    document.getElementById('editNoteContent').value = content;

                    const modalEl = document.getElementById('editNoteModal');
                    const modal = new bootstrap.Modal(modalEl);
                    modal.show();
                });
            });
        });
    </script>
</html>
</body>
</html>
